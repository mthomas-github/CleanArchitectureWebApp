@page "/approvals"
@using Newtonsoft.Json
@implements IAsyncDisposable
@inject HttpClient Http

<PageTitle>Approvals</PageTitle>

<div class="row justify-content-center" style="padding-top: 20px">
    <TelerikLoaderContainer
        OverlayThemeColor="light"
        Visible="@(!IsInitialDataLoadComplete)"
        Text="@null"
        Class="initial-data-loader">
        <Template>
            <TelerikLoader Size="@ThemeConstants.Loader.Size.Large" Type="LoaderType.InfiniteSpinner"/>
        </Template>
    </TelerikLoaderContainer>
    <TelerikGrid
        Data="@GridData"
        Height="@Height"
        Width="35%"
        Class="k-grid grid-no-scroll row-cols-auto"
        FilterMode="GridFilterMode.FilterMenu"
        FilterMenuType="FilterMenuType.CheckBoxList"
        Pageable="true"
        PageSize="@PageSize"
        Sortable="true"
        SortMode="SortMode.Single"
        ShowColumnMenu="true"
        Resizable="true">
        <GridSettings>
            <GridPagerSettings
                InputType="@InputType"
                PageSizes="@PageSizes"
                ButtonCount="@ButtonCount"
                Position="@PagePosition"/>
        </GridSettings>
        <GridColumns>
            <GridColumn Field="ApprovalId" Title="Id" VisibleInColumnChooser="true" Visible="false" Width="20px"/>
            <GridColumn Field="ApproverDisplayName" TextAlign="ColumnTextAlign.Center" Title="Approver" VisibleInColumnChooser="true" Visible="true" Width="5px"/>
            <GridColumn Field="AgreementType" TextAlign="ColumnTextAlign.Center" Title="Agreement Type" VisibleInColumnChooser="true" Visible="true" Width="5px"/>
            <GridCommandColumn Width="5px">
                <GridCommandButton Title="Agreement Info" AriaLabel="Agreement Info" ThemeColor="info" Size="lg" OnClick="@((args) => ToggleWindow(args.Item as ApprovalResponse))" Icon="@SvgIcon.InfoSolid"/>
                <GridCommandButton Title="Approval" AriaLabel="Approval Agreement" ThemeColor="success" Size="lg" Icon="@SvgIcon.Check" OnClick="@((args) => HandleApproval(args.Item as ApprovalResponse))"/>
                <GridCommandButton Title="Decline" AriaLabel="Decline Agreement" ThemeColor="error" Size="lg" Icon="@SvgIcon.X" OnClick="@((args) => HandleDecline(args.Item as ApprovalResponse))"/>
            </GridCommandColumn>
        </GridColumns>
    </TelerikGrid>
</div>

@code {
    private ObservableCollection<ApprovalResponse?> GridData { get; set; } = [];
    private IEnumerable<ApprovalResponse>? AllData { get; set; } = [];
    private const int PageSize = 20;
    private const string Height = "100%";
    private const int ButtonCount = 5;
    bool IsInitialDataLoadComplete { get; set; }
    PagerInputType InputType { get; set; } = PagerInputType.Buttons;
    PagerPosition PagePosition { get; set; } = PagerPosition.Bottom;
    static List<int?> PageSizes => [20, 30, 40, 50, null];
    bool Visible { get; set; }

    private HubConnection _hubConnection = null!;

    public async ValueTask DisposeAsync()
    {
        await _hubConnection.DisposeAsync();
    }


    protected override async Task OnInitializedAsync()
    {
        await StartHubConnection();

        if (IsInitialDataLoadComplete == false)
        {
            AllData = await Http.GetFromJsonAsync<IEnumerable<ApprovalResponse>>($"{GetAllApprovalsEndPoint}");
        }

        if (AllData is not null)
        {
            GridData = new ObservableCollection<ApprovalResponse?>(AllData);
            IsInitialDataLoadComplete = true;
        }

        AddApprovalDataListener();
    }

    private async Task StartHubConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl("https://localhost:28081/approval_payloads")
            .Build();

        await _hubConnection.StartAsync();
        if (_hubConnection.State == HubConnectionState.Connected)
            Console.WriteLine("Connection Started");
    }

    private void AddApprovalDataListener()
    {
        _hubConnection.On<ApprovalResponse>("SendPayload", (payload) =>
        {
            GridData.Add(payload);
            StateHasChanged();
        });
    }

    async Task ToggleWindow(ApprovalResponse? item)
    {
        if (item is not null)
        {
            await Http.GetFromJsonAsync<AgreementResponse>($"{GetAgreementEndPoint}/{item.AgreementId}");
        }

        Visible = !Visible;
    }

    private async Task HandleApproval(ApprovalResponse? item)
    {
        if (item is not null)
        {
            GridData.Remove(item);
            var request = new ApprovalCompleteRequest(item.WorkFlowTaskId, item.TaskId);

            await Http.PutAsJsonAsync($"{CompleteTaskEndPoint}", request);
        }
        else
        {
            throw new NullReferenceException("item was null, unable to complete the task");
        }
    }

    private static Task HandleDecline(ApprovalResponse? item)
    {
        throw new NotImplementedException();
    }

    public class ModelData
    {
        public string? Source { get; set; }
        public int Percentage { get; set; }
        public bool Explode { get; set; }
    }

    public List<ModelData> Data = new List<ModelData>()
    {
        new ModelData()
        {
            Source = "Hydro",
            Percentage = 22,
            Explode = true
        },
        new ModelData()
        {
            Source = "Solar",
            Percentage = 2,
            Explode = false
        },
        new ModelData()
        {
            Source = "Nuclear",
            Percentage = 49,
            Explode = false
        },
        new ModelData()
        {
            Source = "Wind",
            Percentage = 27,
            Explode = false
        }
    };

}